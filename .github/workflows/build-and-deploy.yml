name: Graph Build and Deployment

# on:
#   pull_request:
#     types:
#     - closed
#     branches:
#     - dev

on:
  push:
    branches:
    - github-action

jobs:

#Build the image and push to dockerhub
#The job condition says “Run this for everything EXCEPT non-merged closed PRs”.
  build:
    # if: (!(github.event.action == 'closed' && github.event.pull_request.merged != true))

    name: Build & Push To Dockerhub

    runs-on: ubuntu-latest
    steps:

    - name: Checkout code
      uses: actions/checkout@v3

    - name: Build image
      working-directory: docker
      run: ./build.sh 

    - name: Log in to Docker Hub
      uses: docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9
      with:
        username: ${{ secrets.DOCKER_USER }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Push Graph Node Image to DockerHub
      run: docker push intothefathom/graph-node:latest

  # deploy:
  #   needs: build
  #   name: Deploy
  #   runs-on: ubuntu-latest
    
  #   steps:

  #   - name: Checkout code
  #     uses: actions/checkout@v3

  #   - name: Executing remote command 
  #     uses: appleboy/ssh-action@v0.1.4
  #     with:
  #       host: ${{ secrets.HOST }}
  #       username: ${{ secrets.USERNAME }}
  #       key: ${{ secrets.KEY }}
  #       script: |
  #          rm docker-compose.yml
  #          curl https://raw.githubusercontent.com/Into-the-Fathom/graph-node/dev/docker/docker-compose.yml >> docker-compose.yml && docker stack deploy -c docker-compose.yml graph-node --resolve-image always
           